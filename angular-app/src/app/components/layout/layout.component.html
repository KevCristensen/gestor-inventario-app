<div class="flex h-screen bg-gray-900 text-gray-200 font-sans">
  <!-- MenÃº Lateral -->
  <aside class="relative flex-shrink-0 bg-gray-800 flex flex-col transition-all duration-300 ease-in-out" 
         [ngClass]="isSidebarCollapsed ? 'w-20' : 'w-64'">
    <!-- Encabezado del MenÃº (Fijo) -->
    <div class="flex-shrink-0 flex items-center h-20 px-4 border-b border-gray-700/50">
      <div class="flex items-center" [class.hidden]="isSidebarCollapsed" >
        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
        <h2 class="ml-3 text-xl font-bold">Gestor App</h2>
      </div>
      <button (click)="toggleSidebar()" class="absolute top-6 right-0 transform translate-x-1/2 bg-gray-700 p-2 rounded-full hover:bg-blue-600 focus:outline-none z-10">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
      </button>
    </div>

    <!-- NavegaciÃ³n (Scrollable) -->
    <nav class="flex-grow mt-4 px-4 space-y-2 overflow-y-auto">
      <!-- SecciÃ³n General -->
      <div class="space-y-2">
        <a *ngIf="authService.hasRole(['admin', 'nutricionista', 'bodega'])" routerLink="/dashboard" routerLinkActive="active-link" [routerLinkActiveOptions]="{exact: true}" class="nav-link group">
          <span class="w-6 h-6">ğŸ“Š</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Dashboard</span>
        </a>
        <a *ngIf="authService.hasRole(['admin', 'bodega', 'nutricionista'])" routerLink="/dashboard/reports" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ“„</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Reportes</span>
        </a>
        <!-- NUEVO: Enlace al Chat -->
        <a (click)="chatUiService.openChat()" class="nav-link group cursor-pointer relative">
          <span class="w-6 h-6">ğŸ’¬</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Chat</span>
          @if(unreadChatMessages$ | async; as count) {
            @if(count > 0) {
              <span class="absolute top-1 right-3 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">{{ count }}</span>
            }
          }
        </a>
      </div>

      <!-- SecciÃ³n PlanificaciÃ³n (Nutricionista) -->
      <div *ngIf="authService.hasRole(['admin', 'nutricionista'])" class="pt-4 mt-4 border-t border-gray-700 space-y-2">
        <h3 class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider" [class.hidden]="isSidebarCollapsed">PlanificaciÃ³n</h3>
        <a routerLink="/dashboard/tasks" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ“</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Pautas</span>
        </a>
        <a routerLink="/dashboard/dishes" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ²</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Recetario</span>
        </a>
        <!-- El enlace a AnÃ¡lisis de Minutas ha sido eliminado -->
      </div>

      <!-- SecciÃ³n Bodega -->
      <div *ngIf="authService.hasRole(['admin', 'bodega'])" class="pt-4 mt-4 border-t border-gray-700 space-y-2">
        <h3 class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider" [class.hidden]="isSidebarCollapsed">Bodega</h3>
        <a routerLink="/dashboard/reception" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ“¦</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Recepciones</span>
        </a>
        <a routerLink="/dashboard/exit" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸšš</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Salidas</span>
        </a>
        <a routerLink="/dashboard/products" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Productos</span>
        </a>
        <a routerLink="/dashboard/providers" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ§‘â€ğŸŒ¾</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Proveedores</span>
        </a>
      </div>

      <!-- SecciÃ³n Losa y Equipos -->
      <div *ngIf="authService.hasRole(['admin', 'losa'])" class="pt-4 mt-4 border-t border-gray-700 space-y-2">
        <h3 class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider" [class.hidden]="isSidebarCollapsed">Losa y Equipos</h3>
        <a routerLink="/dashboard/assets" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ½ï¸</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Activos</span>
        </a>
        <a routerLink="/dashboard/asset-inventory" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ“‹</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Inventario</span>
        </a>
        <a routerLink="/dashboard/asset-movements" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ”„</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Movimientos</span>
        </a>
        <a routerLink="/dashboard/loss-damage-report" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ’”</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">PÃ©rdidas</span>
        </a>
      </div>

      <!-- SecciÃ³n AdministraciÃ³n -->
      <div *ngIf="authService.hasRole(['admin'])" class="pt-4 mt-4 border-t border-gray-700 space-y-2">
        <h3 class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider" [class.hidden]="isSidebarCollapsed">AdministraciÃ³n</h3>
        <a routerLink="/dashboard/global-inventory" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸŒ</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Inv. Global</span>
        </a>
        <a routerLink="/dashboard/product-lookup" routerLinkActive="active-link" class="nav-link group">
          <span class="w-6 h-6">ğŸ”</span>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Testear Producto</span>
        </a>
      </div>

    </nav>

    <!-- Pie del MenÃº -->
    <div class="flex-shrink-0 p-4 border-t border-gray-700/50">
        @if (currentUser$ | async; as currentUser) {
          <div class="mb-4">
            <div class="flex items-center" [ngClass]="isSidebarCollapsed ? 'justify-center' : ''">
              <div class="flex-shrink-0 relative">
                <div class="relative">
                  <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                  <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-gray-800" [ngClass]="{
                    'bg-green-400': currentUser.status === 'en linea',
                    'bg-yellow-400': currentUser.status === 'ausente',
                    'bg-red-500': currentUser.status === 'ocupado'
                  }"></span>
                </div>
              </div>
              
              <div class="ml-3" [class.hidden]="isSidebarCollapsed">
                <p class="text-sm font-semibold text-white truncate">{{ currentUser.name }}</p>
                <p class="text-xs text-gray-400">{{ entityName$ | async }}</p>
                <p class="text-xs text-gray-500 capitalize">{{ currentUser.role }}</p>
                <select [ngModel]="currentUser.status" (ngModelChange)="updateStatus($event)" class="mt-1 text-xs bg-gray-700 border-none rounded-md focus:ring-0 p-0.5">
                  <option value="en linea">En lÃ­nea</option>
                  <option value="ausente">Ausente</option>
                  <option value="ocupado">Ocupado</option>
                </select>
              </div>
            </div>
          </div>
        }
      
        <footer class="text-center text-xs text-gray-500 mb-4" [class.hidden]="isSidebarCollapsed">
          <p>KC Smart Systems</p>
          <p>Por Kevin Cristensen</p>
        </footer>
      
        <button (click)="logout()" class="w-full flex items-center justify-center py-2.5 rounded-lg bg-red-600/80 hover:bg-red-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          <span class="ml-3" [class.hidden]="isSidebarCollapsed">Cerrar SesiÃ³n</span>
        </button>
    </div>

    @if (!(isOnline$ | async)) {
      <div class="mt-4 p-2 text-center bg-red-900 bg-opacity-50 rounded-lg text-sm">
        Sin ConexiÃ³n
      </div>
    }
  </aside>

  <main class="flex-1 p-4 md:p-6 lg:p-10 overflow-y-auto">
    <router-outlet></router-outlet>
  </main>

  <!-- ================================================== -->
  <!--           NUEVO: Burbuja y Ventana de Chat         -->
  <!-- ================================================== -->

  <!-- Ventana Flotante del Chat -->
  @if (isChatOpen$ | async) {
    <div class="fixed bottom-24 right-4 w-[800px] h-[600px] bg-gray-800/50 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-700 flex flex-col overflow-hidden z-40"
         style="animation: fade-in-up 0.5s ease-out forwards;">
      <app-chat></app-chat>
    </div>
  }

  <!-- Burbuja Flotante -->
  <button (click)="chatUiService.toggleChat()" class="fixed bottom-6 right-6 w-16 h-16 bg-blue-600 rounded-full shadow-lg flex items-center justify-center text-white z-50 transform hover:scale-110 transition-transform duration-200">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
    @if(unreadChatMessages$ | async; as count) {
      @if(count > 0) {
        <span class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center border-2 border-gray-800">{{ count }}</span>
      }
    }
  </button>
</div>