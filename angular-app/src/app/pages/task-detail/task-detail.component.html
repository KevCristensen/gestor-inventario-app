<div class="text-white">
  @if (isLoading) {
    <div class="text-center p-8 text-gray-500">Cargando detalle de la pauta...</div>
  } @else if (task) {
    <!-- Encabezado -->
    <div class="mb-8">
      <a routerLink="/dashboard/tasks" class="text-blue-400 hover:text-blue-300 mb-4 inline-block">&larr; Volver a Pautas</a>
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-4xl font-bold">{{ task.title }}</h1>
          <p class="text-gray-400">Vence: {{ task.due_date | date:'fullDate' }}</p>
        </div>
        <div class="flex items-start gap-4">
          <span class="text-lg font-semibold px-4 py-2 rounded-full"
                [ngClass]="{
                  'bg-yellow-500 text-yellow-900': task.status === 'pendiente',
                  'bg-blue-500 text-blue-900': task.status === 'en_progreso',
                  'bg-green-500 text-green-900': task.status === 'completada'
                }">
            {{ task.status }}
          </span>
          <button (click)="printTask()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">
            Imprimir
          </button>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Columna Izquierda: Descripci칩n y Asignados -->
      <div class="lg:col-span-2 space-y-6">
        <div class="bg-gray-800 rounded-lg shadow p-6">
          <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Cambiar Estado</h2>
          <div class="flex gap-2">
            <button (click)="updateStatus('pendiente')" [disabled]="task.status === 'pendiente'" class="flex-1 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700 disabled:bg-yellow-500 disabled:text-yellow-900">Pendiente</button>
            <button (click)="updateStatus('en_progreso')" [disabled]="task.status === 'en_progreso'" class="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 disabled:bg-blue-500 disabled:text-blue-900">En Progreso</button>
            <button (click)="updateStatus('completada')" [disabled]="task.status === 'completada'" class="flex-1 py-2 rounded-lg bg-green-600 hover:bg-green-700 disabled:bg-green-500 disabled:text-green-900">Completada</button>
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-6">
          <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Observaciones</h2>
          <textarea [(ngModel)]="task.observations" (blur)="tasksService.updateTaskStatus(task.id, { observations: task.observations }).subscribe()"
                    rows="4" class="w-full bg-gray-700 p-2.5 rounded-lg border border-gray-600" placeholder="A침adir observaciones..."></textarea>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-6">
          <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Descripci칩n</h2>
          <p class="text-gray-300 whitespace-pre-wrap">{{ task.description || 'No hay descripci칩n.' }}</p>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-6">
          <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Personal Asignado</h2>
          @if (task.assignedUsers && task.assignedUsers.length > 0) {
            <div class="flex flex-wrap gap-3">
              @for (user of task.assignedUsers; track user.id) {
                <span class="bg-gray-700 text-gray-200 px-3 py-1 rounded-full text-sm">{{ user.name }}</span>
              }
            </div>
          } @else {
            <p class="text-gray-500">No hay personal asignado a esta pauta.</p>
          }
        </div>
      </div>

      <!-- Columna Derecha: Productos Requeridos y Stock -->
      <div class="bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Productos Requeridos</h2>
        @if (task.requiredProducts && task.requiredProducts.length > 0) {
          <ul class="space-y-4">
            @for (reqProduct of task.requiredProducts; track reqProduct.task_product_id) {
              <li class="p-3 bg-gray-700 rounded-md">
                <div class="flex justify-between items-center font-semibold">
                  <span>{{ reqProduct.name }}</span>
                  <span class="font-mono">{{ reqProduct.required_quantity }} {{ reqProduct.required_unit }}</span>
                </div>

                <!-- Sugerencias de Productos -->
                <div class="mt-3 border-t border-gray-600 pt-3">
                  <h4 class="text-xs text-gray-400 mb-2">Sugerencias con Stock:</h4>
                  <div class="space-y-2">
                    @for(suggestion of reqProduct.suggestions; track suggestion.id) {
                      @if (suggestion.current_stock > 0) {
                        <div class="flex items-center justify-between p-2 rounded-md" [ngClass]="{'bg-blue-900 border border-blue-700': reqProduct.chosen_product_id === suggestion.id, 'bg-gray-800': reqProduct.chosen_product_id !== suggestion.id}">
                          <div>
                            <p class="text-sm font-medium">{{ suggestion.name }} <span class="text-gray-400">- {{ suggestion.brand }}</span></p>
                            <p class="text-xs" [ngClass]="{'text-green-400': suggestion.current_stock >= calculateNeededUnits(reqProduct, suggestion), 'text-red-500': suggestion.current_stock < calculateNeededUnits(reqProduct, suggestion)}">
                              Stock: {{ suggestion.current_stock | number }} un. | Necesitas: {{ calculateNeededUnits(reqProduct, suggestion) }} un.
                            </p>
                          </div>
                          <button (click)="selectProductForRequirement(reqProduct.task_product_id, suggestion.id)" 
                                  [disabled]="reqProduct.chosen_product_id === suggestion.id"
                                  class="text-xs px-2 py-1 rounded bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed">
                            {{ reqProduct.chosen_product_id === suggestion.id ? 'Elegido' : 'Elegir' }}
                          </button>
                        </div>
                      }
                    } @empty {
                      <p class="text-xs text-yellow-500">No se encontraron productos con stock que coincidan.</p>
                    }
                  </div>
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="text-gray-500">Esta pauta no requiere productos.</p>
        }
      </div>
    </div>
  } @else {
    <div class="text-center p-8 text-gray-500">No se pudo encontrar la pauta solicitada.</div>
  }
</div>
